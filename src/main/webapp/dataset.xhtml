<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <h:head>
    </h:head>

    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="#{empty DatasetPage.dataset.latestVersion.title ? 'Add New Dataset' : DatasetPage.dataset.latestVersion.title} - #{DatasetPage.dataset.owner.name}"/>
            <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
            <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
            <ui:param name="showBreadcrumbs" value="#{empty DatasetPage.editMode}"/>
            <ui:param name="showMessagePanel" value="#{true}"/>
            <ui:define name="body">

                <f:metadata>
                    <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                    <f:viewParam name="ownerId" value="#{DatasetPage.ownerId}"/>
                    <f:viewAction action="#{DatasetPage.init}" />
                </f:metadata>

                <h:form id="datasetForm">

                    <!-- Header / Button Panel -->
                    <ui:fragment>
                        
                        <!-- View mode -->
                        <ui:fragment rendered="#{empty DatasetPage.editMode}">
                            <div id="topDatasetBlock">
                                <div id="actionButtonBlock" style="float:right;">
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode}">
                                        <div style="float:right; margin-left:1em;">
                                            <div class="btn-group">
                                                <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                    <span class="glyphicon glyphicon-pencil" style="margin-right:.3em;"/> Edit Dataset <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu pull-right" role="menu" style="text-align:left;">
                                                    <li>
                                                        <p:commandLink id="editFiles" actionListener="#{DatasetPage.edit('FILE')}" update="@all">
                                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                            <h:outputText value="Files (Upload + Edit)" />
                                                        </p:commandLink>   
                                                    </li>
                                                    <li>
                                                        <p:commandLink id="editMetadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@all">
                                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                            <h:outputText value="Metadata" />
                                                        </p:commandLink>   
                                                    </li>
                                                    <!--<li><a href="#" class="ui-commandlink ui-widget" style="pointer-events: none; color: grey;">Permissions</a></li>-->
                                                </ul>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode}">
                                        <div style="float:right; margin-left:1em;">
                                            <div class="btn-group">
                                                <button type="button" id="releaseDataset" class="btn btn-default dropdown-toggle" data-toggle="dropdown" >
                                                    <ui:fragment rendered="#{!DatasetPage.dataset.released}">
                                                    <span class="glyphicon glyphicon-ban-circle" style="margin-right:.3em;"/> Private <span class="caret"></span>
                                                    </ui:fragment>
                                                    <ui:fragment rendered="#{DatasetPage.dataset.released}">
                                                    <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Published  <span class="caret"></span>
                                                    </ui:fragment>
                                                </button>
                                                <ui:fragment rendered="#{!DatasetPage.dataset.released}">
                                                    <ul class="dropdown-menu pull-right" role="menu" style="text-align:left;"  >
                                                        <li>
                                                            <a  style="pointer-events: none; color:red;">
                                                                <span class="glyphicon glyphicon-ban-circle" style="margin-right:.3em;"/> Private
                                                                <span style="display:block;color:#777;font-size:small;">This dataset is Private. To publish it click 'Publish dataset' link</span>
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a style="pointer-events: none; color:green;">
                                                                <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Public
                                                                <span style="display:block;color:#777;font-size:small;"><p:commandLink value="Publish Dataset" onclick="confirmation.show()"  /></span>
                                                            </a>
                                                        </li>                                                    
                                                    </ul>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{DatasetPage.dataset.released}">
                                                    <ul class="dropdown-menu pull-right" role="menu" style="text-align:left;"  >

                                                        <li>
                                                            <a style="pointer-events: none; color:green;">
                                                                <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Public
                                                                <span style="display:block;color:#777;font-size:small;">This dataset has been published.</span>
                                                            </a>
                                                        </li>                                                    
                                                    </ul>
                                                </ui:fragment>
                                            </div>
                                        </div>
                                        <p:growl id="messages" showDetail="true" />  
                                        <p:confirmDialog message="Are you sure you want to publish your dataset? Once you do so it must remain 'Public'."  header="Publish Dataset"  widgetVar="confirmation">  
                                                <p:commandButton value="Continue"  onclick="confirmation.hide()"  action="#{DatasetPage.releaseDataset}" >
                                                </p:commandButton>  
                                                <p:commandButton value="Cancel" onclick="confirmation.hide()" type="button" />   
                                        </p:confirmDialog>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{empty DatasetPage.editMode}">
                                        <div style="float:right;">
                                            <button type="button" class="btn btn-default">
                                                <span class="glyphicon glyphicon-envelope" style="margin-right:.3em;"/> Email Dataset Contact
                                            </button>
                                        </div>
                                    </ui:fragment>
                                </div>
                                <div id="datasetVersionBlock">
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.title.value}">
                                        <span id="title" class="clearfix">#{DatasetPage.datasetVersionUI.title.value}</span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.citation}">
                                        <div id="citation">
                                            <span>#{DatasetPage.datasetVersionUI.citation}</span>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.description.value}">
                                        <span id="description">#{DatasetPage.datasetVersionUI.description.value}</span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.keywordsStr}">
                                        <span id="keywords">Keyword(s): #{DatasetPage.datasetVersionUI.keywordsStr}</span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.subjectStr}">
                                        <span id="subject">Subject(s): #{DatasetPage.datasetVersionUI.subjectStr}</span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.relPublicationCitation}">
                                        <span id="publication">Related Publication: #{DatasetPage.datasetVersionUI.relPublicationCitation}  <a href="#{DatasetPage.datasetVersionUI.relPublicationUrl}" target="_blank">#{DatasetPage.datasetVersionUI.relPublicationUrl}</a></span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.notesText}">
                                        <span id="note">Notes: #{DatasetPage.datasetVersionUI.notesText}</span>
                                    </ui:fragment>
                                </div>
                            </div>
                        </ui:fragment>

                        <!-- Create mode -->
                        <ui:fragment rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE'}">
                            <div class="form-group">
                                <label for="select_HostDataverse" class="col-sm-2 control-label">
                                    <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="The Dataverse which contains this data.">Host Dataverse</a>
                                </label>
                                <div class="col-sm-10">
                                    <p:selectOneMenu id="select_HostDataverse" value="#{DatasetPage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                        <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"/>
                                    </p:selectOneMenu>
                                </div>
                            </div>
                        </ui:fragment>
                        <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                            <ui:include src="metadataFragment.xhtml"/>
                        </ui:fragment>
                    </ui:fragment>

                    <!-- Tabs -->
                    <ui:fragment rendered="#{DatasetPage.editMode != 'INFO'}">
                        <div id="contentTabs">
                        <ui:fragment rendered="#{empty DatasetPage.editMode}">
                            <p:commandButton id="refreshButton" widgetVar="refreshButton" actionListener="#{DatasetPage.refresh}" update="tabView:filesTable" style="display:none"/>
                            <script type="text/javascript">
                                function updateFilesTable(facesmessage) {
                                    $('button[id$="refreshButton"]').trigger('click');
                                }
                            </script>
                            <p:socket channel="/ingest#{dataset.id}" onMessage="updateFilesTable" autoConnect="true">
                                <p:ajax event="message" update="tabView:filesTable" />
                            </p:socket>
                        </ui:fragment>


                        <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}">
                            <p:tab id="dataFilesTab" title="Files" rendered="#{(empty DatasetPage.editMode or DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}" >
                                <!-- Upload -->
               .                 <!--<p:message for="fileUpload" showDetail="true"/>-->
                                <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                                    <div class="alert alert-info">
                                        Tip: You can drag and drop your files from your desktop, directly into the upload widget.
                                    </div>
                                </ui:fragment>
                                <p:fileUpload id="fileUpload" dragDropSupport="true" auto="true" multiple="true" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"
                                              fileUploadListener="#{DatasetPage.handleFileUpload}" update="filesTable" label="Select Files to Add"/> <!-- style="margin-top:.5em;"/ -->
                                <!-- View -->
                                <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode}">
                                    <div class="containder" style="text-align:right; margin-bottom:.5em;">
                                        <p:commandLink style="color:black;" styleClass="btn btn-default" title="Upload + Edit Files" actionListener="#{DatasetPage.edit('FILE')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            <span class="glyphicon glyphicon-plus" style="margin-right:.3em;"/> Upload + Edit Files
                                        </p:commandLink>
                                    </div>
                                    <!--<p class="bg-info" style="padding:1em; margin-right:200px;">
                                        <h:outputText value="Use the Edit Dataverse button to edit or add metadata to this dataset." />
                                    </p>-->
                                </ui:fragment>

                                <p:dataTable id="filesTable" value="#{DatasetPage.dataset.files}" var="file">
                                    <p:column styleClass="col-xs-1" style="text-align:center;">
                                        
                                        <ui:fragment rendered="#{!empty file.id and file.image}">
                                            <a data-trigger="hover" data-toggle="popover" data-placement="right" data-html="true" data-content="&lt;img src=&#34;/api/access/datafile/#{file.id}?imageThumb=400&#34; alt=&#34;Preview&#34; /&gt;">
                                                <p:graphicImage value="/api/access/datafile/#{file.id}?imageThumb=true"/>
                                            </a>
                                        </ui:fragment>
                                        
                                        
                                        <p:graphicImage value="/resources/images/icon_file.png" rendered="#{!file.image}"/>
                                        
                                        <ui:fragment rendered="#{empty file.id and !empty file.fileSystemName and file.image}">
                                            <p:graphicImage value="/api/access/imagethumb/#{file.fileSystemName}"/>
                                            <h:outputText id="imgPreview" value="Preview" styleClass="bg-info text-info" style="display:block;text-align:center;"/>
                                        </ui:fragment>
                                    </p:column>
                                    <p:column styleClass="col-sm-7">
                                        <h:outputText id="fileNameOutput" value="#{file.name}" style="display:block;font-weight:bold;" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}"/>
                                        
                                        <ui:fragment rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}">
                                            <label class="control-label" for="fileName" style="margin-right:1em;margin-bottom:.5em;">
                                                File Name
                                            </label>
                                            <p:inputText id="fileName" value="#{file.name}" style="margin-bottom:.5em;"/>
                                            <p:message for="fileName"/>
                                        </ui:fragment>
                                        
                                        <h:outputText id="fileTypeOutputRegular" value="#{file.friendlyType}#{!empty file.md5 ? ', ' : ''}" rendered="#{!(file.tabularData)}"/>
                                        <h:outputText id="fileMD5" value="MD5: #{file.md5}" rendered="#{!(empty file.md5) and !(file.tabularData)}"/>
                                        
                                        <h:outputText id="fileTypeOutputTabular" value="Tabular Data#{!empty file.unf ? ', ' : ''}" rendered="#{file.tabularData}"/>
                                        <h:outputText id="fileUNF" value="#{file.unf}" rendered="#{!empty file.unf}"/>
                                        
                                        <div class="fileDescription">
                                            <h:outputText id="fileDescNonEmpty" value="#{file.description}" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and !(empty file.description)}"/>
                                            <!--<h:outputText id="fileDescEmpty" value="NO DESCRIPTION AVAILABLE" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and (empty file.description)}"/>-->

                                            <ui:fragment rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}">
                                                <label class="control-label" for="fileDescription" style="margin-right:1em; margin-top:.5em; vertical-align:top;">
                                                    Description
                                                </label>
                                                <p:inputTextarea id="fileDescription" rows="2" cols="40" value="#{file.description}" style="margin-top:.5em;"/>
                                                <p:watermark for="fileDescription" value="Add file description..."/>
                                                <p:message for="fileDescription"/>
                                            </ui:fragment>
                                        </div>
                                    </p:column>
                                    <p:column styleClass="col-sm-4" style="overflow: auto;text-align:right;" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}">
                                        
                                        
                                        <ui:fragment rendered="#{file.tabularData}">
                                            <h:outputLink style="margin-right:1em;color:black;font-size:1em;" styleClass="btn btn-default" title="Explore" value="/dataexplore/gui.html?dfId=#{file.id}" target="_blank" rendered="#{file.tabularData and !(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}">
                                                <span class="glyphicon glyphicon-stats" style="margin-right:.3em;"/> Explore
                                            </h:outputLink>
                                        </ui:fragment>
                                        
                                        <ui:fragment rendered="#{file.ingestInProgress}">
                                            <p:graphicImage value="/resources/images/icon_inprogress.gif"/>
                                        </ui:fragment>
                                        
                                        <ui:fragment rendered="#{!(file.tabularData)}">
                                            <a class="btn btn-default" href="/api/access/datafile/#{file.id}" role="button" style="color:#333333;">
                                                <span class="glyphicon glyphicon-download-alt" style="margin-right:.3em;"/> Download
                                            </a>
                                        </ui:fragment>
                                        
                                        <!--<p:button value="Download" disabled="#{empty file.id}" rendered="#{empty file.id}"/>-->
                                        
                                        <ui:fragment rendered="#{file.tabularData}">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                    <span class="glyphicon glyphicon-download-alt" style="margin-right:.3em;"/> Download <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu" role="menu" style="text-align:left;">
                                                    <li>
                                                        <h:outputLink value="/api/access/datafile/#{file.id}"  disabled="#{empty file.id}">
                                                            <h:outputText value="As Tab-Delimited"/>
                                                        </h:outputLink>
                                                    </li>
                                                    <li>
                                                        <h:outputLink value="/api/access/datafile/#{file.id}?fileFormat=RData"  disabled="#{empty file.id}">
                                                            <h:outputText value="As RData"/>
                                                        </h:outputLink>
                                                    </li>
                                                    <li>
                                                        <h:outputLink value="/api/access/datafile/#{file.id}?fileFormat=original"  disabled="#{empty file.id}">
                                                            <h:outputText value="Saved Original (#{file.originalFormatLabel})"/>
                                                        </h:outputLink>
                                                    </li>
                                                    <li>
                                                        <h:outputLink value="/api/meta/datafile/#{file.id}"  disabled="#{empty file.id}">
                                                            <h:outputText value="Variable Metadata"/>
                                                        </h:outputLink>
                                                    </li>
                                                </ul>
                                            </div>
                                        </ui:fragment>
                                        
                                        <ui:fragment rendered="#{file.ingestInProgress}">
                                            <h:outputText id="txtInprogess" value="Ingest in progress..." styleClass="bg-info text-info" style="display:block;text-align:center;"/>
                                        </ui:fragment>
                                        
                                    </p:column>
                                </p:dataTable>
                            </p:tab>

                            <p:tab id="metadataMapTab" title="Metadata" rendered="#{empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA'}">

                                <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode}">
                                    <div class="containder" style="text-align:right; margin-bottom:.5em;">
                                        <p:commandLink style="color:black;" styleClass="btn btn-default" title="Edit Metadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            <span class="glyphicon glyphicon-pencil" style="margin-right:.3em;"/> Edit Metadata
                                        </p:commandLink>
                                    </div>
                                    <!--<p class="bg-info" style="padding:1em; margin-right:200px;">
                                        <h:outputText value="Use the Edit Dataverse button to edit or add metadata to this dataset." />
                                    </p>-->
                                </ui:fragment>
                                <div style="clear:left;">
                                    <ui:include src="metadataFragment.xhtml"/>
                                </div>
                                
                            </p:tab>

                            <p:tab id="versionsTab" title="Versions" rendered="#{empty DatasetPage.editMode}">
                                <p:dataTable id="versionsTable" value="#{DatasetPage.dataset.versions}" var="version">
                                    <p:column>
                                        <h:outputText id="versionTitleOutput" value="#{version.title}" />
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="versionDateOutput" value="#{version.createTime}" />
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="versionStatusOutput" value="#{version.versionState}" />
                                    </p:column>
                                </p:dataTable>
                            </p:tab>
                        </p:tabView>
                        </div>
                    </ui:fragment>

                    <!-- Create/Save Dataset Button Panel -->
                    <p:panel styleClass="panelLayoutButtonBlock" rendered="#{!empty DatasetPage.editMode}">
                        <p:commandButton id="save"  value="#{DatasetPage.editMode == 'CREATE' ? 'Create Dataset' : 'Save Changes'}" action="#{DatasetPage.save}" update="@all">
                        </p:commandButton>
                        <p:commandButton id="cancel" value="Cancel" action="#{DatasetPage.cancel}" process="@this" update="@all"  rendered="#{DatasetPage.editMode != 'CREATE'}">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                        <p:button id="cancelCreate" value="Cancel" outcome="/dataverse.xhtml?id=#{DatasetPage.ownerId}"  rendered="#{DatasetPage.editMode == 'CREATE'}" />
                    </p:panel>

                </h:form>

            </ui:define>
        </ui:composition>
        
        
    </h:body>
</html>
